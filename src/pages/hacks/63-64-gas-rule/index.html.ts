// metadata
export const version = "0.8.26"
export const title = "63 / 64 Gas Rule"
export const description = "An example of 63 / 64 gas rule"
export const cyfrinLink = ""

export const keywords = ["hack", "security", "63", "64", "gas"]

export const codes = [
  {
    fileName: "Gas.sol",
    code: "Ly8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCmNvbnRyYWN0IEEgewogICAgZnVuY3Rpb24gZihhZGRyZXNzIGIpIGV4dGVybmFsIHsKICAgICAgICB1aW50MjU2IGdhc1N0YXJ0ID0gZ2FzbGVmdCgpOwogICAgICAgIEIocGF5YWJsZShiKSkuZyhtc2cuc2VuZGVyLCBnYXNTdGFydCk7CiAgICB9Cn0KCmNvbnRyYWN0IEIgewogICAgZXZlbnQgTG9nKHVpbnQyNTYgZ2FzKTsKCiAgICBtYXBwaW5nKGFkZHJlc3MgPT4gYm9vbCkgcHVibGljIGF1dGhvcml6ZWQ7CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgYXV0aG9yaXplZFttc2cuc2VuZGVyXSA9IHRydWU7CiAgICB9CgogICAgcmVjZWl2ZSgpIGV4dGVybmFsIHBheWFibGUge30KCiAgICBmdW5jdGlvbiBzZXRBdXRoKGFkZHJlc3MgYWRkciwgYm9vbCBhdXRoKSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShhdXRob3JpemVkW21zZy5zZW5kZXJdLCAibm90IGF1dGhvcml6ZWQiKTsKICAgICAgICBhdXRob3JpemVkW2FkZHJdID0gYXV0aDsKICAgIH0KCiAgICAvLyBTZW5kIDkwMDAwMDAwMDAwMDAwMDAwMDAgZ2FzIHRvIGRyYWluIEVUSAogICAgZnVuY3Rpb24gZyhhZGRyZXNzIHJlY2VpdmVyLCB1aW50MjU2IGdhc1N0YXJ0KSBleHRlcm5hbCB7CiAgICAgICAgcmVxdWlyZShhdXRob3JpemVkW21zZy5zZW5kZXJdLCAibm90IGF1dGhvcml6ZWQiKTsKCiAgICAgICAgdWludDI1NiBnYXNOb3cgPSBnYXNsZWZ0KCk7CiAgICAgICAgdWludDI1NiBnYXNVc2VkID0gZ2FzU3RhcnQgLSBnYXNOb3c7CiAgICAgICAgLy8gRml4CiAgICAgICAgLy91aW50MjU2IGdhc1VzZWQgPSBnYXNTdGFydCAtIChnYXNOb3cgLyA2MykgLSBnYXNOb3c7CiAgICAgICAgKGJvb2wgb2ssKSA9IHJlY2VpdmVyLmNhbGx7dmFsdWU6IGdhc1VzZWR9KCIiKTsKICAgICAgICByZXF1aXJlKG9rLCAic2VuZCBmYWlsZWQiKTsKCiAgICAgICAgZW1pdCBMb2coZ2FzVXNlZCk7CiAgICB9Cn0KCi8qCiMgNjMgLyA2NCBnYXMgcnVsZQpFeHRlcm5hbCBjYWxscyByZWNlaXZlIG1heCA2MyAvIDY0IG9mIGdhcyBsZWZ0IGluIGN1cnJlbnQgY29udHJhY3QKMSAvIDY0IGdhcyBpcyBrZXB0IGluIHRoZSBjdXJyZW50IGNvbnRyYWN0CgpnMCA9IGNhbGwgdG8gZ2FzbGVmdCgpIHNvbWV3aGVyZSBpbiBBCmcxID0gY2FsbCB0byBnYXNsZWZ0KCkgc29tZXdoZXJlIGluIEIKZyogPSBBY3R1YWwgZ2FzIGxlZnQgaW1tZWRpYXRlbHkgYmVmb3JlIGNhbGwgdG8gQgoKICBnKiAgICA2My82NCBnKgpBIHwtLS0tPnwgQgp8ICAgICAgICAgfApnMCAgICAgICAgZzEKCiMgR2FzIHVzZWQKZGcgPSBnYXMgdXNlZCBiZXR3ZWVuIGcwIGFuZCBnMQogICA9IGcwIC0gZyogKyA2My82NCBnKiAtIGcxCiAgID0gZzAgLSBnMSAtIDEvNjQgZyogPj0gMAoKIyBQcm9ibGVtCi0gUmVmdW5kIG9mIGcwIC0gZzEgb3ZlciBwYXlzIGJ5IDEvNjQgZyoKLSBnKiBjYW4gYmUgbGFyZ2UgYnkgc2VuZGluZyBsYXJnZSBhbW91bnQgb2YgZ2FzCgojIEZpeApnMSA8PSA2My82NCBnKiA8PSBnMApnMS82MyA8PSAxLzY0IGcqIDw9IGcwLzYzCmcwIC0gZzEgLSBnMS82MyA+PSBnMCAtIGcxIC0gMS82NCBnKiA+PSBnMCAtIGcxIC0gMS82MyBnMCA9IDYyLzYzIGcwIC0gZzEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID49IDAKClJlZnVuZCBnMCAtIGcxIC0gZzEvNjMKKi8K",
  },
]

const html = `<p>According to 63 / 64 gas rule, external calls receive at most 63 / 64 of remaining gas in the calling contract.</p>
<h3>Vulnerability</h3>
<p>Contracts that refund gas used must account for this 1/64 gas that is not spent.</p>
<p>Here is a simplified example of a contract that refunds gas.</p>
<pre><code class="language-solidity"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
<span class="hljs-meta"><span class="hljs-keyword">pragma</span> <span class="hljs-keyword">solidity</span> ^0.8.26;</span>

<span class="hljs-class"><span class="hljs-keyword">contract</span> <span class="hljs-title">A</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">f</span>(<span class="hljs-params"><span class="hljs-keyword">address</span> b</span>) <span class="hljs-title"><span class="hljs-keyword">external</span></span> </span>{
        <span class="hljs-keyword">uint256</span> gasStart <span class="hljs-operator">=</span> <span class="hljs-built_in">gasleft</span>();
        B(<span class="hljs-keyword">payable</span>(b)).g(<span class="hljs-built_in">msg</span>.<span class="hljs-built_in">sender</span>, gasStart);
    }
}

<span class="hljs-class"><span class="hljs-keyword">contract</span> <span class="hljs-title">B</span> </span>{
    <span class="hljs-function"><span class="hljs-keyword">event</span> <span class="hljs-title">Log</span>(<span class="hljs-params"><span class="hljs-keyword">uint256</span> gas</span>)</span>;

    <span class="hljs-keyword">mapping</span>(<span class="hljs-keyword">address</span> <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">bool</span>) <span class="hljs-keyword">public</span> authorized;

    <span class="hljs-function"><span class="hljs-keyword">constructor</span>(<span class="hljs-params"></span>) </span>{
        authorized[<span class="hljs-built_in">msg</span>.<span class="hljs-built_in">sender</span>] <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">receive</span>(<span class="hljs-params"></span>) <span class="hljs-title"><span class="hljs-keyword">external</span></span> <span class="hljs-title"><span class="hljs-keyword">payable</span></span> </span>{}

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setAuth</span>(<span class="hljs-params"><span class="hljs-keyword">address</span> addr, <span class="hljs-keyword">bool</span> auth</span>) <span class="hljs-title"><span class="hljs-keyword">external</span></span> </span>{
        <span class="hljs-built_in">require</span>(authorized[<span class="hljs-built_in">msg</span>.<span class="hljs-built_in">sender</span>], <span class="hljs-string">"not authorized"</span>);
        authorized[addr] <span class="hljs-operator">=</span> auth;
    }

    <span class="hljs-comment">// Send 9000000000000000000 gas to drain ETH</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">g</span>(<span class="hljs-params"><span class="hljs-keyword">address</span> receiver, <span class="hljs-keyword">uint256</span> gasStart</span>) <span class="hljs-title"><span class="hljs-keyword">external</span></span> </span>{
        <span class="hljs-built_in">require</span>(authorized[<span class="hljs-built_in">msg</span>.<span class="hljs-built_in">sender</span>], <span class="hljs-string">"not authorized"</span>);

        <span class="hljs-keyword">uint256</span> gasNow <span class="hljs-operator">=</span> <span class="hljs-built_in">gasleft</span>();
        <span class="hljs-keyword">uint256</span> gasUsed <span class="hljs-operator">=</span> gasStart <span class="hljs-operator">-</span> gasNow;
        <span class="hljs-comment">// Fix</span>
        <span class="hljs-comment">//uint256 gasUsed = gasStart - (gasNow / 63) - gasNow;</span>
        (<span class="hljs-keyword">bool</span> ok,) <span class="hljs-operator">=</span> receiver.<span class="hljs-built_in">call</span>{<span class="hljs-built_in">value</span>: gasUsed}(<span class="hljs-string">""</span>);
        <span class="hljs-built_in">require</span>(ok, <span class="hljs-string">"send failed"</span>);

        <span class="hljs-keyword">emit</span> Log(gasUsed);
    }
}

<span class="hljs-comment">/*
# 63 / 64 gas rule
External calls receive max 63 / 64 of gas left in current contract
1 / 64 gas is kept in the current contract

g0 = call to gasleft() somewhere in A
g1 = call to gasleft() somewhere in B
g* = Actual gas left immediately before call to B

  g*    63/64 g*
A |----&gt;| B
|         |
g0        g1

# Gas used
dg = gas used between g0 and g1
   = g0 - g* + 63/64 g* - g1
   = g0 - g1 - 1/64 g* &gt;= 0

# Problem
- Refund of g0 - g1 over pays by 1/64 g*
- g* can be large by sending large amount of gas

# Fix
g1 &lt;= 63/64 g* &lt;= g0
g1/63 &lt;= 1/64 g* &lt;= g0/63
g0 - g1 - g1/63 &gt;= g0 - g1 - 1/64 g* &gt;= g0 - g1 - 1/63 g0 = 62/63 g0 - g1
                                     &gt;= 0

Refund g0 - g1 - g1/63
*/</span>
</code></pre>`

export default html
